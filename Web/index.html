<!DOCTYPE html>
<!--        To run this avoiding the cross-origin file request nonsense, cd into THIS (/Web) directory and run the following:
                            python -m http.server                            
                    then browse to:                             
                            localhost:8000                             
                    to launch the page.
-->
<!-- Test: Typical fullscreen usage; autoload an image and overlay. -->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- iOS meta tags -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="stylesheet" type="text/css" href="js/papaya/Papaya-master/build/papaya.css?build=8675327" />
  <script type="text/javascript" src="js/papaya/Papaya-master/build/papaya.js?build=8675327"></script>
  <link rel="stylesheet" type="text/css" href="js/vendor/slick-1.6.0/slick/slick.css"/>
  <link rel="stylesheet" type="text/css" href="js/vendor/slick-1.6.0/slick/slick-theme.css"/>
  <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
  <script type="text/javascript" src="https://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
  <script src="https://code.jquery.com/jquery.min.js"></script> 
  <script type="text/javascript" src="js/vendor/slick-1.6.0/slick/slick.min.js"></script>
<link rel="stylesheet" type="text/css" href="js/vendor/slick-1.6.0/slick/slick.css">
  <link rel="stylesheet" type="text/css" href="js/vendor/slick-1.6.0/slick/slick-theme.css"/>
  <link rel="stylesheet" type="text/css" href="js/vendor/css/slider.css"/>
  <script type="text/javascript" src="js/vendor/bootstrap-slider.js"></script>
  <style type="text/css">
    html, body {
      margin: 0 auto;
      padding: 0;
      background: #3F3F3F;
      background-image: url('img/turtle_shell.jpg');
    }
    .clear-both {
       clear: both;
    }
    #sub-left {
       overflow: hidden;
       float: left;
    }
    #sub-right {
       overflow: hidden;
       float: right;
    }    
    nav { background: #2ba0db; width: 97%; margin:0 auto;  }
    nav ul {
      font-size: 0;
      margin: 0;
      padding: 0;
    }
    nav ul li {
      display: inline-block;
      position: relative;
    }
    nav ul li a {
      color: #fff;
      display: block;
      font-size: 14px;
      font-color: #fff
      padding: 15px 14px;
      transition: 0.3s linear;
    }
    nav ul li:hover { background: #c5c5c5; }
    nav ul li ul {
      border-bottom: 5px solid #2ba0db;
      display: none;
      position: absolute;
      width: 250px;
    }
    nav ul li ul li {
      border-top: 1px solid #444;
      display: block;
    }
    nav ul li ul li:first-child { border-top: none; }
    nav ul li ul li a {
      background: #F5F5DC;
      display: block;
      padding: 10px 14px;
    }
    nav ul li ul li a:hover { background: #c5c5c5; }    
    .container2 {
        display: flex;
    }
    #view_and_info1 {
      list-style-type: none; display: inline; 
      }      
    #view_and_info1 li{
      list-style-type: none;
      border-right: 1px solid #ffffff; width:250; 
    }    
    .column {
        flex: 1;        
        background: #f2f2f2;
        border: 1px solid #e6e6e6;
    }
    .column-one {
        order: 1;
    }
    .column-two {
        order: 2;
    }
    .column-three {
        order: 3;
    }
    .smallViewer {
        margin:20px;width:500px;height:415px;
    }    
    .midViewer {
        margin:1px;width:950px;height:790px;margin:0 auto; 
    }    
    .roiViewer {
        margin:1px;width:775px;height:790px; margin:0 auto; 
    }
    .left {
        float: left;
    }
    .right {
        float: right;
    }    
    .float_center {
        float: right;
        position: relative;
        right: 42%; /* or right 50% */
        text-align: left;
    }    
    .rcorners1 {
        border-radius: 25px;
        background: #f1f1f1;
        position: relative;
        padding: 15px;         
    }    
    .rcorners2 {
        border-radius: 10px;
        background: #f1f1f1;
        padding: 3px;  
        position: relative;
        left: -2%;        
    }        
    #ex1Slider .slider-selection {
	    background: #BABABA;
	     position: relative;
	     width:200px;height:15px; 
    }    
    .roi-viz-tools {
        background: #ffffff;
    }         
  </style>
    <script type="text/javascript">
    
    var LoadNewSurfaces = function(index, opt){
        var surfs = [];
        var rgbs = [];
        var fnames = [];
        var data = brain_region_struct;
        surfs.push("img/linked_content/Templates/DTI_exvivo/ROIs/ev_dti_brain.surf.gii");    
        fnames.push("ev_dti_brain.surf.gii")              
        for(var i=13; i < 21; i++){
        
            if(!data["rois"][i]["data"]["path"])
            {
                console.log("Skipping index # -> "+i);
            }
            else
            {
                var datapath = data["rois"][i]["data"]["path"];
                var fname       = data["rois"][i]["data"]["filename"];
                var red             = parseFloat((parseFloat(data["rois"][i]["data"]["red"]) )/255);
                var green        = parseFloat((parseFloat(data["rois"][i]["data"]["green"]) )/255);
                var blue          = parseFloat((parseFloat(data["rois"][i]["data"]["blue"]) )/255);                    
                console.log("Processing .... " + data["rois"][i]["data"]["path"] + data["rois"][i]["data"]["filename"] + "   with color:  ("+red+", "+green+", "+blue+")");                    
                surfs.push(datapath+fname);
                fnames.push(fname);
                rgbs.push([red,green,blue]);
            }
        }        
        params["surfaces"] = surfs;
        for(var j=0;j<fnames.length;j++){     
            console.log("THE SHORT FILENAME :  " + String(fnames[j]));               
            if(String(fnames[j]) == "ev_dti_brain.surf.gii"){
                params[String(fnames[j])] = {color: [0.8,0.8,0.8], alpha: 0.75};
            } else {
                params[String(fnames[j])] = {color: rgbs[j], alpha: 1};
            }
        }                
        params["showSurfacePlanes"] = false;
        params["surfaceBackground"] = "Black";                  
        params.showControls = false;   
        params["kioskMode"] = true;    
        if(opt == 1)
        {
            papaya.Container.showImage([0,0]);
        }
        else
        {
            console.log("Not showing the image.");
        }
    };
    
    var GetRegionDataByName = function(name){    
        var roi_list = brain_region_struct["rois"];
        var description = ""
        for(var i=0; i < roi_list.length; i++){
            if(name == roi_list[i]["data"]["name"]){
                description = roi_list[i]["data"]["description"];
            }
        }
        return description;
    };
    var params  = [];           
    var brain_region_struct = {};    
    var image_map = {}; 
            image_map["ExVivo_DTI_FA"] =    [0,0];
            image_map["ExVivo_DTI_DEC"] =   [0,1];       
            image_map["ExVivo_DTI_TR"] =    [0,2];
            var rois={}; 
            
            $.getJSON('ext/Brain_Regions.json', function(data) { 
                console.log("PRINTING ROI OBJECT........"+data)                                
                brain_region_struct = data;
                var surfs = [];
                var fnames = [];
                var rgbs = [];
                surfs.push("img/linked_content/Templates/DTI_exvivo/ROIs/ev_dti_brain.surf.gii");    
                fnames.push("ev_dti_brain.surf.gii")                
                var current_image = "";            
                params["images"] =  [                                            
                                        "img/linked_content/Templates/DTI_exvivo/Volumes/ExVivo_DTI_FA.nii", 
                                        "img/linked_content/Templates/DTI_exvivo/Volumes/ExVivo_DTI_DEC.nii", 
                                        "img/linked_content/Templates/DTI_exvivo/Volumes/ExVivo_DTI_TR.nii"
                                     ];                
                params["ExVivo_DTI_FA.nii"] = {"lut": "Hot-Cool", "min": 0, "max": 1};
                params["ExVivo_DTI_DEC.nii"] = {"min": 0, "max": 255}; 
                params["ExVivo_DTI_TR.nii"] = {"lut": "Hot-Cool", "min": 0, "max": 1500};                
                LoadNewSurfaces(image_map[current_image],0);
            });                                  
    </script>
    <script type="text/javascript">
    $(document).ready(function(){
        $("#roi-viz-tools").show();
        $("#ex1Slider").show();
        $("#ex_vivo_dti").hide();       
        $("#view_and_info1").hide()                    
        $("#visualization_templates").hide()
        $("#image_actions").hide()
        var hide_image = function(index){            
            papaya.Container.hideImage(index[0], index[1]);
        };
        var show_image = function(index){
            papaya.Container.showImage(index[0], index[1]);
        };
        var get_cursor_location = function(index){
            var res = papaya.Container.GetCursorLocation(index[1], index[0]);
            var loc = res[0];
            console.log("LOCATION ->  " + loc)                      
        };
        var get_roi_label = function(index){
            var res = papaya.Container.GetCursorLocation(index[1], index[0]);
            var lbl = res[1];            
            var desc = GetRegionDataByName(lbl);
            var r_str = "<h3>"+lbl+"</h3>";
            var d_str = "<h3>"+desc+"</h3>";
            $("#current_roi").html(r_str);
            $("#roi_description").html(d_str);
            set_roi_alpha($("#current_roi").val(), parseFloat((parseFloat($("#ex1").val()) / 100.0)));
        };
        var set_surface_alpha = function(index, val){
            papaya.Container.SetSurfaceAlpha(0,0, val);
            papaya.Container.showImage(0,0);
            console.log("Setting surface alpha to "+val);
        };
        var set_roi_alpha_val = function(idx, val){                     
            console.log("Setting roi alpha to "+val);
            papaya.Container.SetSurfaceAlpha(0, idx, val);
            papaya.Container.showImage(0, idx);
        };
        var set_roi_alpha = function(roi, val){
            var surface_idx = papaya.Container.GetSurfaceIndexByName(0, $("#current_roi")[0].innerText);
            console.log("The current ROI is ->  " + roi + " with index ->       " + surface_idx);            
            if(parseInt(surface_idx) >= 0)
            {            
                for(var i = 0; i < papaya.Container.GetNumberOfSurfaces(0); i++)
                {
                    if(i == parseInt(surface_idx))
                    {
                        console.log("FOUND THE RIGHT INDEX.")
                        set_roi_alpha_val(parseInt(surface_idx), 0.95);
                    }
                    else
                    {
                        console.log("FOUND THE wrong INDEX.")
                        if(i>0)
                        {
                            set_roi_alpha_val(i, 0.0);
                        }
                    }
                }
            }
            else
            {
                console.log("Empty result.");
            }
            //set_surface_alpha(0,0, 0.75);  
        };
        var reset_viewer = function( ){
            var keys = [];
            for (var key in image_map) {
              if (image_map.hasOwnProperty(key)) {
                keys.push(key);
              }
            }
            for(var i = 0; i < keys.length; i++){
                hide_image(image_map[keys[i]]);
            }
        };
        var reset_roi_info = function( ){
            $("#ROI_area1").hide()
        };
        var set_background_color_for_list = function( list, color ){        
            for( i in list){
                $(list[i]).css('background', color);
            }
        };
        var update_params = function(img){           
            reset_viewer();   
            if ( img == "ev_dti_dec" ){             
                current_image = "ExVivo_DTI_DEC"
                show_image(image_map[current_image]);
                set_background_color_for_list(["#ev_dec_txt"], '#126d9b');
                set_background_color_for_list(["#ev_tr_txt","#ev_fa_txt"], '#fff');
                $("#img_description1").html( "<i>Directionally Encoded Map</i>" )
                $("#template1_info").html(
                     $("<div></div>").append([
                        $("<u>Type of Image:  </u>"),                        
                        $("#img_description1"),
                        $("<br>"),
                        $("<p>ROI name: </p>").append($("#current_roi")),
                        $("<br>"),
                        $("<p>ROI description: </p>").append($("#roi_description"))
                    ])
                )                                
            } else if ( img == "ev_dti_fa" ){
                current_image = "ExVivo_DTI_FA";
                show_image(image_map[current_image]);
                set_background_color_for_list(["#ev_fa_txt"], '#126d9b');
                set_background_color_for_list(["#ev_tr_txt","#ev_dec_txt"], '#fff');
                $("#img_description1").html( "<i>Fractional Anisotropy</i>" )
                $("#template1_info").html(
                     $("<div></div>").append([
                        $("<u>Type of Image:  </u>"),                        
                        $("#img_description1"),
                        $("<br>"),
                        $("<p>ROI name: </p>").append($("#current_roi")),
                        $("<br>"),
                        $("<p>ROI description: </p>").append($("#roi_description"))
                    ])
                ) 
            } else if ( img == "ev_dti_tr" ){
                current_image = "ExVivo_DTI_TR"
                show_image(image_map[current_image]);
                set_background_color_for_list(["#ev_tr_txt"], '#126d9b');
                set_background_color_for_list(["#ev_dec_txt","#ev_fa_txt"], '#fff');
                $("#img_description1").html( "<i>Trace</i>" )
                $("#template1_info").html(
                     $("<div></div>").append([
                        $("<u>Type of Image:  </u>"),                        
                        $("#img_description1"),
                        $("<br>"),
                        $("<p>ROI name: </p>").append($("#current_roi")),
                        $("<br>"),
                        $("<p>ROI description: </p>").append($("#roi_description"))
                    ])
                )
            } else {
                console.log("SOMETHING ELSE!");                                                       
            }
        };    
        var show_surface = function(index){
            console.log("SURFACE INDEX ->  " + index)
            if(index == 0){            
                $("#papaya1").show()     
                $("#ROI_area1").show()        
                $("#view_and_info1").show()
            } else {
                console.log("Unknown surface request index: "+index);
            }                        
        };        
        $('nav li').hover(
            function() {
            $('ul', this).stop().slideDown(200);                
            },
            function() {
            $('ul', this).stop().slideUp(200);
            }
        );                
        $("#papaya1").on('click', function(e) {        
            console.log("From papaya 1.")
            console.log("CURRENT IMAGE ->  " +current_image)
            get_cursor_location(image_map[current_image]);          
            get_roi_label(image_map[current_image]);  
        });
        $("#evdti").on('click', function(e) {  
            console.log("CLICKED Ex-Vivo DTI Template");                               
             $("#ex_vivo_dti").show();           
             $("#view_and_info1").show();             
             $("#ex1Slider").show();
             reset_viewer();
        });
        $("#reset_view").on('click', function(e) {
            console.log("Resetting Viewport.");
            reset_viewer();
        });        
        $("#show_roi_content").on('click', function(e) {
            console.log("Showing ROI content.")
            reset_roi_info();
        });
        $("#minimize_all").on('click', function(e) { 
            reset_viewer();
            $("#ex_vivo_dti").hide();            
            $("#view_and_info1").hide();
            $("#roi-viz-tools").hide();
        });
        $("#create_png").on('click', function(e) {
            console.log("Create PNG selected.");
        });			
		var ex1Change = function() { 
		    console.log("Ex-vivo DTI Slider value :   " + parseFloat((parseFloat($("#ex1").val()) / 100.0)));	
		    set_surface_alpha(image_map[current_image], parseFloat((parseFloat($("#ex1").val()) / 100.0)));    
	    };
        $('#ex1').slider({
	        formatter: function(value) {
		        return 'Current s1 value: ' + value;
	        }
        }).on('slide', ex1Change).data('slider');		        
        
        $("#ex_vivo_dti_dec").on('click', function(e) {  
            console.log("CLICKED Ex-vivo DEC"); 
            current_image="ExVivo_DTI_DEC"; 
            reset_viewer(); 
            update_params("ev_dti_dec"); 
            show_surface(0);
        });
        $("#ex_vivo_dti_tr").on('click', function(e) {  
            console.log("CLICKED Ex-vivo Trace");  
            current_image="ExVivo_DTI_TR"; 
            reset_viewer();
            update_params("ev_dti_tr"); 
            show_surface(0);
        });
        $("#ex_vivo_dti_fa").on('click', function(e) {  
            console.log("CLICKED Ex-vivo FA");  
            current_image="ExVivo_DTI_FA"; 
            reset_viewer(); 
            update_params("ev_dti_fa"); 
            show_surface(0);
        });
        $("#visualization_analysis").on('click', function(e) { 
                    console.log("CLICKED visualization analysis"); 
                    $("#current_service").html("Visualization");             
                    $("#image_actions").show()
                    $("#visualization_templates").show()
        });        
        $("#NewSurfaces").on('click', function(e) {
            console.log("Loading new surfaces...");
            LoadNewSurfaces(image_map[current_image],1);
        });
        var current_h = null;
        var current_w = null;
        $("#ex_vivo_dti").hover(
            function(){
                current_h = $("#ex_vivo_dti_dec_img").height();
                current_w = $("#ex_vivo_dti_dec_img").width();
                $("#ex_vivo_dti_dec_img").stop(true, false).animate({width: (current_w * 1.4), height: (current_h * 1.4)}, 200);
                $("#ex_vivo_dti_fa_img").stop(true, false).animate({width: (current_w * 1.4), height: (current_h * 1.4)}, 200);
                $("#ex_vivo_dti_tr_img").stop(true, false).animate({width: (current_w * 1.4), height: (current_h * 1.4)}, 200);
            },
            function(){
                $("#ex_vivo_dti_dec_img").stop(true, false).animate({width: current_w + 'px', height: current_h + 'px'}, 150);
                $("#ex_vivo_dti_fa_img").stop(true, false).animate({width: current_w + 'px', height: current_h + 'px'}, 150);
                $("#ex_vivo_dti_tr_img").stop(true, false).animate({width: current_w + 'px', height: current_h + 'px'}, 150);
            }
        );        
          
    });    
    </script>
    <title>Template Web Viewer</title>
</head>
<body>
    <nav class="navbar navbar-inverse" >
      <div class="container-fluid"  >
        <div class="navbar-header">    
          <a class="navbar-brand dropdown-toggle" href="#" data-toggle="dropdown">NIH MRI Viewer<span class="caret"></span></a>      
            <ul class="dropdown-menu">
             <li class="dropdown">
              <li id="visualization_analysis"><a href="#">Visualization and Image Analysis</a></li>
            </ul>
          </li>
        </div>
        <ul class="nav navbar-nav navbar-inverse">
          <li class="active"><a href="#"><div id="current_service"><----</div></a></li>
          <li id="visualization_templates" class="dropdown"><a class="dropdown-toggle" href="#" data-toggle="dropdown">Templates<span class="caret"></span></a>
            <ul class="dropdown-menu">
              <li id="evdti"><a href="#">Ex-Vivo DTI</a></li>
            </ul>
          </li>
          <li id="image_actions" class="dropdown"><a class="dropdown-toggle" href="#" data-toggle="dropdown">Actions<span class="caret"></span></a>
            <ul class="dropdown-menu">
                <li id="show_roi_content"><a href="#">Show ROI info</a></li>
                <li id="reset_view"><a href="#">Reset View</a></li>
                <li id="minimize_all"><a href="#">Minimize All</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </nav>
    <div class="container-fluid" >
        <div class="row" height="50">
            <div class="row" id="ex_vivo_dti">    
                <ul class="pager">        
                    <li id="ex_vivo_dti_fa">
                    <a href="#">
                        <img id="ex_vivo_dti_fa_img" class="ex_vivo_fa" src="img/linked_content/Templates/DTI_exvivo/Thumbnails/ExVivo_DTI_FA.png" alt="Fractional Anisotropy Map (ex-vivo)" height="50" width="50"> 
                        <p id="ev_fa_txt" style="margin:0 auto;">FA</p>
                    </a>
                    </li>              
                    <li id="ex_vivo_dti_dec">
                    <a href="#">
                        <img id="ex_vivo_dti_dec_img" class="ex_vivo_dec" src="img/linked_content/Templates/DTI_exvivo/Thumbnails/ExVivo_DTI_DEC.png" alt="Directionally Encoded Color Map (ex-vivo)" height="50" width="50"> 
                        <p id="ev_dec_txt" style="margin:0 auto;">DEC</p>
                    </a>
                    </li>               
                    <li id="ex_vivo_dti_tr">
                    <a href="#">
                        <img id="ex_vivo_dti_tr_img" class="ex_vivo_tr" src="img/linked_content/Templates/DTI_exvivo/Thumbnails/ExVivo_DTI_TR.png" alt="Trace Map (ex-vivo)" height="50" width="50">
                        <p id="ev_tr_txt" style="margin:0 auto;">TR</p> 
                    </a>
                    </li>
                </ul>
            </div>      
        </div>
    </div>
    <div id="roi-viz-tools" class="pager">
        <input id="ex1" data-slider-id='ex1Slider' type="text" data-slider-min="0" data-slider-max="100" data-slider-step="1" data-slider-value="75">
        <div id="NewSurfaces">NEW SURFS</div>
    </div>
    <div class="container-fluid" id="view_and_info1">
       <ul>
       <li>
            <div id="ROI_area1" class="roiViewer rcorners2 right">
              <div class="jumbotron">
                <p style="margin:0 auto"><b><h1>Ex-Vivo DTI</h1></b></p>
              </div>
                    <div id="template1_info">
                        Image description: <div id="img_description1"></div>
                        <br>
                        ROI name: <div id="current_roi"></div>
                        <br>
                        ROI description: <div id="roi_description"></div>
                    </div>                            
            </div>       
       </li>   
       <li>
            <div id="papaya1" class="midViewer rcorners1 left">                 
                <div class="papaya" data-params="params" ></div>                             
            </div> 
       </li>
       </ul>       
    </div>
</body>
</html>
